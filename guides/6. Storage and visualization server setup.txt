####Work in progress####


This guide assumes that operational syslog server on Ubuntu Server 14.04 LTS virtual machine with working network connection is installed and accessible via SSH. Basic understanding of vim command is assumed but configuration can be carried out with other editors as well. Functional custom CA setup is required with make_cert.sh script. Syslog server must be operational. Commands must be carried out as root user, execution via sudo is possible but untested. Relevant entries must be appended to presented configuration files or, if already present, altered according to temlates within this guide. Relevant services must be restarted for changes to take effect.

Storage + visualization serveri is configured separately from regular correlation server (Guide 2.). This is due to the fact that described components require java (personal preference, but I do not like mixing it with other solututions). Server can be used independantly as central log collector, or , in my case, all logs from syslog-ng correlation server will be forwarded here for storage and visualization.

Please change domain.ex with your own domain name. Same goes for server names.

1. Set up certificates

# Create certificates 
# Ref. Guide 3. (Server side points 1. and 2.)

2. Set up Rsyslog 8 log collector

# We use rsyslog 8 ppa, since earlier version does not provide elasticsearch plugin

add-apt-repository ppa:adiscon/v8-stable
apt-get update && apt-get dist-upgrade && apt-get dist-upgrade
apt-get -y install rsyslog-elasticsearch rsyslog-gnutls

vim /etc/rsyslog.conf

"""
...
$ModLoad imtcp
...
"""

vim /etc/rsyslog.d/remote.conf

"""
# TLS driver load
$DefaultNetstreamDriver gtls

# certificate files
$DefaultNetstreamDriverCAFile /etc/ssl/syslog/cacert.pem
$DefaultNetstreamDriverCertFile /etc/ssl/syslog/cert.pem
$DefaultNetstreamDriverKeyFile /etc/ssl/syslog/key.pem

$ActionSendStreamDriverAuthMode x509/name
$InputTCPServerStreamDriverPermittedPeer *.domain.ex
$InputTCPServerStreamDriverMode 1 # run driver in TLS-only mode
$InputTCPServerRun 6514 # start up listener at port 6514
"""

# For simple change in domain name value, 
# Don't forget to escape the dot (matching is done using regular expressions; unescaped dot means "match anything")

export domain_name=<your_domain_name>

sed -i s/domain\.ex/$domain_name/g /etc/rsyslog.d/remote.conf

service rsyslog restart

2.1. Forward all logs from central syslog-ng server to rsyslog-elasticsearch server

# On central server

vim /etc/syslog-ng/syslog-ng.conf

"""
...
destination d_kibana_server {
        syslog(
                kibana.domain.ex
                transport("tls")
                port(6514)
                tls( peer-verify(required-trusted) ca_dir('/etc/ssl/syslog/') key_file('/etc/ssl/syslog/orion.domain.ex-key.pem') cert_file('/etc/ssl/syslog/orion.domain.ex-cert.pem'))
        );
};
...
log {
        source(s_remote_ietf);
        source(s_src);
        destination(d_local);
        destination(d_kibana_server);
};
...
"""

service syslog-ng restart

3. Set up elasticsearch server

apt-get install openjdk-7-jre-headless -y

# Download elasticsearch installer
cd /opt/
export elastic_version=elasticsearch-1.2.0.deb
wget https://download.elasticsearch.org/elasticsearch/elasticsearch/$elastic_version
dpkg -i $elastic_version

# add to startup
update-rc.d elasticsearch defaults 95 10

# start server
/etc/init.d/elasticsearch start

4. Configure rsyslog to forward logs to elasticsearch

vim /etc/rsyslog.d/elasticsearch.conf

#form http://blog.sematext.com/2013/07/01/recipe-rsyslog-elasticsearch-kibana/

"""
module(load="imuxsock")             # for listening to /dev/log
module(load="omelasticsearch") # for outputting to Elasticsearch
# this is for index names to be like: logstash-YYYY.MM.DD
template(name="logstash-index"
  type="list") {
    constant(value="logstash-")
    property(name="timereported" dateFormat="rfc3339" position.from="1" position.to="4")
    constant(value=".")
    property(name="timereported" dateFormat="rfc3339" position.from="6" position.to="7")
    constant(value=".")
    property(name="timereported" dateFormat="rfc3339" position.from="9" position.to="10")
}

# this is for formatting our syslog in JSON with @timestamp
template(name="plain-syslog"
  type="list") {
    constant(value="{")
      constant(value="\"@timestamp\":\"")     property(name="timereported" dateFormat="rfc3339")
      constant(value="\",\"host\":\"")        property(name="hostname")
      constant(value="\",\"severity\":\"")    property(name="syslogseverity-text")
      constant(value="\",\"facility\":\"")    property(name="syslogfacility-text")
      constant(value="\",\"tag\":\"")   property(name="syslogtag" format="json")
      constant(value="\",\"message\":\"")    property(name="msg" format="json")
    constant(value="\"}")
}
# this is where we actually send the logs to Elasticsearch (localhost:9200 by default)
action(type="omelasticsearch"
    template="plain-syslog"
    searchIndex="logstash-index"
    dynSearchIndex="on")
"""

/etc/init.d/rsyslog restart

